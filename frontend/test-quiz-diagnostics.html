<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Engine Diagnostics</title>
    
    <!-- Include the app CSS for proper styling -->
    <link rel="stylesheet" href="css/app-optimized.css">
    <link rel="stylesheet" href="css/quiz-engine.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        /* Diagnostic-specific styles */
        .diagnostic-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .diagnostic-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-top: 20px;
        }
        .test-list {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 20px;
            max-height: 800px;
            overflow-y: auto;
        }
        .console-log {
            background: #000;
            color: #0f0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            padding: 20px;
            border-radius: 8px;
            height: 800px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .quiz-test-item {
            background: var(--bg-tertiary);
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
        }
        .quiz-test-item:hover {
            background: var(--primary-green);
            color: black;
        }
        .format-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
        }
        .format-a { background: #10b981; color: white; }
        .format-b { background: #f59e0b; color: white; }
        .format-c { background: #8b5cf6; color: white; }
        .format-unknown { background: #ef4444; color: white; }
        .log-error { color: #ff6b6b; }
        .log-success { color: #51cf66; }
        .log-warning { color: #feca57; }
        .log-info { color: #74b9ff; }
        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        .control-button {
            background: var(--primary-green);
            color: black;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .control-button:hover {
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <!-- Matrix Rain Background -->
    <canvas id="matrix-rain" class="matrix-rain"></canvas>
    
    <div class="diagnostic-container">
        <h1 style="text-align: center; color: var(--primary-green); margin-bottom: 30px;">
            Quiz Engine Diagnostics
        </h1>
        
        <div class="controls">
            <button class="control-button" onclick="testAll()">Test All Quizzes</button>
            <button class="control-button" onclick="clearLog()">Clear Log</button>
            <button class="control-button" onclick="window.location.href='quiz.html'">Go to Quiz App</button>
        </div>
        
        <div class="diagnostic-grid">
            <div class="test-list" id="quiz-list">
                <h3 style="color: var(--primary-green); margin-bottom: 15px;">Available Quizzes</h3>
                <!-- Quiz items will be loaded here -->
            </div>
            
            <div class="console-log" id="console">
                <div class="log-entry log-info">Quiz Engine Diagnostics Started</div>
                <div class="log-entry log-info">Click on a quiz to test it individually</div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { QuizLoader } from './js/quiz-engine/quiz-loader.js';
        import { UnifiedTopicSelector } from './js/quiz-engine/topic-selector-unified.js';
        import { MatrixRain } from './js/quiz-engine/matrix-rain.js';
        
        // Initialize matrix rain
        const canvas = document.getElementById('matrix-rain');
        if (canvas) {
            const matrixRain = new MatrixRain(canvas);
            matrixRain.start();
        }
        
        const loader = new QuizLoader();
        const consoleEl = document.getElementById('console');
        const quizListEl = document.getElementById('quiz-list');
        
        // Override console methods to capture output
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        console.log = (...args) => {
            originalLog(...args);
            log(args.join(' '), 'info');
        };
        
        console.error = (...args) => {
            originalError(...args);
            log(args.join(' '), 'error');
        };
        
        console.warn = (...args) => {
            originalWarn(...args);
            log(args.join(' '), 'warning');
        };
        
        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            consoleEl.appendChild(entry);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }
        
        window.clearLog = function() {
            consoleEl.innerHTML = '<div class="log-entry log-info">Log cleared</div>';
        };
        
        // Quiz metadata
        const quizzes = {
            neuroanat: [
                'content/quizzes/Neuroanat/1-3 Koponya_gerinc_látópálya.html',
                'content/quizzes/Neuroanat/4-6. Középagy_tekintés_szemmozgás.html',
                'content/quizzes/Neuroanat/7-11. NV_VII_vestib_hallás.html',
                'content/quizzes/Neuroanat/12-15. Szédülés_bulbaris_híd.html',
                'content/quizzes/Neuroanat/16-20. kisagy_thalamus_caps interna_basalis ggl.html',
                'content/quizzes/Neuroanat/21-24. mozgato_paresis_prefront_kérgiszerk.html',
                'content/quizzes/Neuroanat/25-27. Dominancia_asszoc_érzőrendszerek.html',
                'content/quizzes/Neuroanat/28-30. Occip_perieet_temporalis.html',
                'content/quizzes/Neuroanat/31-34. limbik_magatart_memória_hippocamp.html',
                'content/quizzes/Neuroanat/35-38. Hypothal_hypophys_beszéd_fájdalom.html',
                'content/quizzes/Neuroanat/39-40. gerincvelő_izomtónus.html',
                'content/quizzes/Neuroanat/41-43. plexus_cerv_lumb_sacr_autonom.html',
                'content/quizzes/Neuroanat/44-48. agyi keringés (carotis, vertebro, gv, vénás).html',
                'content/quizzes/Neuroanat/49-53. Vénás anatómia_gvvérell_vénáskeringés_sinuscavernosus_thalamusésbasalisggl.html',
                'content/quizzes/Neuroanat/54-59.  agy víztér, BBB, vér-liquor, transzmitterek.html'
            ],
            vizsmod: [
                'content/quizzes/Vizsgálómódszerek, alap klinikum/60-64. EEG, alvás, ürítés, plasztic, genetika.html',
                'content/quizzes/Vizsgálómódszerek, alap klinikum/65-69. gyógyszer, liquor, EEG, EP.html',
                'content/quizzes/Vizsgálómódszerek, alap klinikum/70-75 EMG_ENG_CT_MR_ANGIO_UH.html',
                'content/quizzes/Vizsgálómódszerek, alap klinikum/76-79. HEMAT_SZAGLÁS_TEKINTÉS_PUPILLA.html',
                'content/quizzes/Vizsgálómódszerek, alap klinikum/80-84.DIPLOPA_NYSTAGMUS_NFAC_BELL_DYSARTH_DYSPHAG.html',
                'content/quizzes/Vizsgálómódszerek, alap klinikum/85-89. IZOMGYEENG_ÉRZÉS_DISSZOC_REFLEX_KISAGY.html',
                'content/quizzes/Vizsgálómódszerek, alap klinikum/90-95. ATAXIA_APHASIA_NEGLECT_APRAXIA_EXEKUTIV.html',
                'content/quizzes/Vizsgálómódszerek, alap klinikum/96-99. LIBERÁCIÓS_ESZMÉLETLEN_ZAVART_HYPNOID.html',
                'content/quizzes/Vizsgálómódszerek, alap klinikum/100-105. NEMHYPN_HERNIA_DEMENCIA_EMLÉKE.html'
            ],
            klinikum: [
                'content/quizzes/Klinikum/180-187. TRANSZPLAT_PARKINSON_OSAS_ALVÁS.html',
                'content/quizzes/Klinikum/188-194. PARKINSONP_DYSTONIA_WILSON_TREMOR.html',
                'content/quizzes/Klinikum/195-199. BOTOX_JARAS_IGESEB_MENINGITIS.html',
                'content/quizzes/Klinikum/200-206. ANTIBIO_NEUROINFEKT_PRION_ENCEPH.html',
                'content/quizzes/Klinikum/207-212. ENCEPHALITIS_BELL_MONONEURO_POLY.html',
                'content/quizzes/Klinikum/213-219. POLYNEURO_ALAGUT_MOTONEURON_IZOMDYS.html',
                'content/quizzes/Klinikum/220-225. MYOPATHIA_FÁJDALOMSY_MIGRÉN_TENSIO_NEURALGIA.html'
            ]
        };
        
        // Load quiz list
        function loadQuizList() {
            let html = '';
            for (const [category, paths] of Object.entries(quizzes)) {
                html += `<h4 style="color: var(--primary-green); margin: 15px 0 10px;">${category.toUpperCase()}</h4>`;
                paths.forEach(path => {
                    const filename = path.split('/').pop();
                    html += `
                        <div class="quiz-test-item" onclick="testQuiz('${path}')">
                            ${filename}
                        </div>
                    `;
                });
            }
            quizListEl.innerHTML += html;
        }
        
        // Test individual quiz
        window.testQuiz = async function(path) {
            log(`\n========== Testing: ${path} ==========`, 'success');
            
            try {
                // Test loading
                const startTime = Date.now();
                const quizData = await loader.loadQuiz(path);
                const loadTime = Date.now() - startTime;
                
                log(`✓ Loaded in ${loadTime}ms`, 'success');
                log(`Format: ${quizData.format}`, 'info');
                log(`Questions: ${quizData.questions.length}`, 'info');
                log(`Topics: ${quizData.availableTopics?.length || 0}`, 'info');
                
                if (quizData.availableTopics && quizData.availableTopics.length > 0) {
                    log('Available topics:', 'info');
                    quizData.availableTopics.forEach(topic => {
                        log(`  - ${topic.key}: ${topic.name}`, 'info');
                    });
                }
                
                // Show sample question
                if (quizData.questions.length > 0) {
                    const q = quizData.questions[0];
                    log('\nSample question:', 'info');
                    log(`Q: ${q.question.substring(0, 100)}...`, 'info');
                    log(`Answers: ${Object.keys(q.answers).length}`, 'info');
                    log(`Correct: ${q.correctAnswer}`, 'info');
                    log(`Has explanation: ${!!q.explanation}`, 'info');
                }
                
            } catch (error) {
                log(`✗ Error: ${error.message}`, 'error');
                log(`Stack: ${error.stack}`, 'error');
            }
        };
        
        // Test all quizzes
        window.testAll = async function() {
            log('\n========== TESTING ALL QUIZZES ==========', 'success');
            
            let totalSuccess = 0;
            let totalFailed = 0;
            const results = {};
            
            for (const [category, paths] of Object.entries(quizzes)) {
                log(`\n=== Category: ${category.toUpperCase()} ===`, 'warning');
                results[category] = { success: 0, failed: 0 };
                
                for (const path of paths) {
                    try {
                        const quizData = await loader.loadQuiz(path);
                        if (quizData.questions.length > 0) {
                            log(`✓ ${path.split('/').pop()} - ${quizData.questions.length} questions`, 'success');
                            results[category].success++;
                            totalSuccess++;
                        } else {
                            log(`✗ ${path.split('/').pop()} - No questions found`, 'error');
                            results[category].failed++;
                            totalFailed++;
                        }
                    } catch (error) {
                        log(`✗ ${path.split('/').pop()} - ${error.message}`, 'error');
                        results[category].failed++;
                        totalFailed++;
                    }
                }
            }
            
            // Summary
            log('\n========== SUMMARY ==========', 'warning');
            for (const [category, stats] of Object.entries(results)) {
                log(`${category}: ${stats.success} success, ${stats.failed} failed`, 
                    stats.failed > 0 ? 'error' : 'success');
            }
            log(`\nTotal: ${totalSuccess} success, ${totalFailed} failed`, 
                totalFailed > 0 ? 'error' : 'success');
        };
        
        // Initialize
        loadQuizList();
    </script>
</body>
</html>